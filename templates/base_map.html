{% extends 'base.html' %}

{% load humanize %}
{% load sekizai_tags %}
{% load template_functions %}

{% block js_content %}

  {% addtoblock "css_link" %}
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}simplegeo-polymaps/examples/example.css">
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}simplegeo-polymaps/lib/colorbrewer/colorbrewer.css">
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/map-styles.css">
  {% endaddtoblock %}

  {% addtoblock "js_script" %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/d3.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/protovis/protodata.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/polymaps.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svg.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svgdom.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/highcharts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/charts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/maps.js"></script>
  {% endaddtoblock %}

  {{ block.super }}

  <script type="text/javascript">

    $(document).ready(function() {

      print_pie_chart('#main_topics', 'main_topics_chart' );
      print_pie_chart('#main_types', 'main_types_chart' );

      var tiles_url = "http://{S}tile.cloudmade.com"
          + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
          + "/20760/256/{Z}/{X}/{Y}.png";
      var mapfactory = new MAP( {{ map.data|safe }}, '{{ TILESTACHE_URL }}', tiles_url , d3, org.polymaps, pv);
      var mappoi = {{ map.poi|safe }};

      mapfactory.build('map', {{ map.extent }}, {{ map.zoomlev|default:"null" }}, {{ map.zoomrange|default:"null" }});

      if ( mappoi ) {
        //console.log(mappoi);
        mapfactory.add_point( mappoi );
      }
      else {
        mapfactory.add_layer( $('#selectors .active').prop('id'), $('#map-layer-selector .block-chart.block-active').data('dataset') );


        $('#selectors .btn').click(function() {

          $('#selectors .btn.active').removeClass('active');

          mapfactory.add_layer($(this).prop('id'), $('#map-layer-selector .block-chart.block-active').data('dataset'));

          $(this).addClass("active");

          return false;
        });

        $('#map-layer-selector .block-chart').click(function(){

          $('#map-layer-selector .block-chart.block-active').removeClass('block-active');
          // add layer
          mapfactory.add_layer(  $('#selectors .active').prop('id') ,$(this).data('dataset') );

          $(this).addClass('block-active');

          return false;
        })
      }

    });
  </script>

{% endblock %}

{% block container %}

  <div class="container">

    <div class="row">

      <div class="span6 block-container" id="map-layer-selector">

        <div class="block-chart block-active" data-dataset="costo">

          <strong class="title">Finanziamento pubblico complessivo dei progetti monitorati*</strong>

          <p>{{ total_cost|intword }} <span>di euro</span></p>

          <div class="bar-vertical"></div>

        </div>

        <div class="block-chart" title="{{ cost_payments_ratio }} del totale" data-dataset="pagamento">

          <strong class="title">Pagamenti effettuati per i progetti monitorati*</strong>

          <p>{{ total_cost_paid|intword }} <span>di euro</span></p>

          <div class="bar-vertical"><span style="height:{{ cost_payments_ratio }}"></span></div>

        </div>

        <div class="block-chart" data-dataset="numero">

          <strong class="title">Numero dei progetti monitorati*</strong>

          <p>{{ total_projects|intcomma }}</p>

        </div>

      </div>
      <div>

        {% block top_content %}

        <div class="block-chart block-gray pull-right">
          <strong class="title">Totale risorse stanziate*</strong>
          <p>{{ total_allocated_resources|intword }} <span>di euro</span></p>
        </div>

        <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit.
          Integer dolor odio, lobortis ut pulvinar eget, tincidunt ac enim.
          Vivamus libero nisi, viverra at scelerisque nec, laoreet in nibh.
          Proin ornare urna ut velit condimentum mollis.
          Maecenas egestas lorem vitae eros vestibulum posuere.</p>

          {% endblock %}

      </div>

    </div>

  </div>

  <div class="area">
    <div class="container">

      <div class="row" id="statistics">

        <div class="span6">

          <div class="row">
            {% if tipologie_principali %}
            <div class="span3">
              <h5>Tipologie</h5>

              <p>Le tipologie di progetti e gli importi ad esse dedicati.</p>

              <div id="main_types_chart" style="width: 100%; height: 200px"></div>

              <table id="main_types" class="table table-bordered">
                {% for tipologia in tipologie_principali %}
                  <tr>
                    <td><a href="{{ tipologia.get_absolute_url }}" title="{{ tipologia.descrizione }}">{{ tipologia.short_label }}</a></td>
                    {% if territorio %}
                    <td class="amount"><strong>{{ tipologia|args:territorio|call:'costo_totale'|intcomma }}</strong> euro</td>
                    {% else %}
                    <td class="amount"><strong>{{ tipologia.costo_totale|intcomma }}</strong> euro</td>
                    {% endif %}
                  </tr>
                {% endfor %}
              </table>

            </div>
            {% endif %}

            {% if temi_principali %}
            <div class="span3">
              <h5>Temi</h5>

              <p>Le tematiche che riguardano i progetti e gli importi ad esse dedicati.</p>

              <div id="main_topics_chart" style="width: 100%; height: 200px"></div>

              <table id="main_topics" class="table table-bordered">
                {% for tema in temi_principali %}
                  <tr>
                    <td><a href="{{ tema.get_absolute_url }}" title="{{ tema.descrizione }}">{{ tema.short_label }}</a></td>
                    {% if territorio %}
                      <td class="amount"><strong>{{ tema|args:territorio|call:'costo_totale'|intcomma }}</strong> euro</td>
                    {% else %}
                      <td class="amount"><strong>{{ tema.costo_totale|intcomma }}</strong> euro</td>
                    {% endif %}

                  </tr>
                {% endfor %}
              </table>

            </div>
            {% endif %}
          </div>

        </div>

        <div class="span6">

          <div id="selectors" class="btn-group">
            {% if territorio.territorio == 'R' %}
              <a href="#" id="province" class="btn active">province</a><a href="#" id="comuni" class="btn">comuni</a>
            {% elif territorio.territorio == 'P' %}
              <a href="#" id="comuni" class="btn active">comuni</a>
            {% elif territorio.territorio == 'C' %}
              <a href="#" id="comuni" class="btn active">{{ territorio }}</a>
            {% else %}
              <a href="#" id="regioni" class="btn active">regioni</a><a href="#" id="province" class="btn">province</a>
            {% endif %}
          </div>
          <div id="map"{% if territorio.territorio == 'C' %} style=" height: 400px; "{% endif %}></div>
          <span id="copy">
            &copy; 2010
            <a href="http://www.cloudmade.com/">CloudMade</a>,
            <a href="http://www.openpolis.it/">Openpolis</a>,
            <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.
            Colors by <a href="http://colorbrewer.org/">Cynthia Brewer</a>.
          </span>

        </div>
      </div>

    </div>
  </div>



{% endblock %}