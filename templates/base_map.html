{% extends 'base.html' %}

{% load humanize %}
{% load sekizai_tags %}
{% load template_functions %}

{% block js_content %}

  {% addtoblock "css_link" %}
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}simplegeo-polymaps/examples/example.css">
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}simplegeo-polymaps/lib/colorbrewer/colorbrewer.css">
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/map-styles.css">
  {% endaddtoblock %}

  {% addtoblock "js_script" %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-tooltip.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/bootstrap-popover.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/d3.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/protovis/protodata.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/polymaps.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svg.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svgdom.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/highcharts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/charts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/maps.js"></script>
  {% endaddtoblock %}

  {{ block.super }}

  <script type="text/javascript">

    $(document).ready(function() {

      $('#main_topics').length && print_pie_chart('#main_topics', 'main_topics_chart' );
      $('#main_types').length && print_pie_chart('#main_types', 'main_types_chart' );

      var tiles_url = "http://{S}tile.cloudmade.com"
          + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
          + "/20760/256/{Z}/{X}/{Y}.png";
      var mapfactory = new MAP( {{ map.data|safe }}, '{{ TILESTACHE_URL }}', tiles_url , d3, org.polymaps, pv);
      var mappoi = {{ map.poi|safe }};

      mapfactory.build('map', {{ map.extent }}, {{ map.zoomlev|default:"null" }}, {{ map.zoomrange|default:"null" }});

      if ( mappoi ) {
        mapfactory.add_point( mappoi );
      }
      else {
        mapfactory.add_layer( $('#selectors .active').prop('id'), $('#map-layer-selector .block-chart.block-active').data('dataset') );


        $('#selectors .btn').click(function() {

          $('#selectors .btn.active').removeClass('active');

          mapfactory.add_layer($(this).prop('id'), $('#map-layer-selector .block-chart.block-active').data('dataset'));

          $(this).addClass("active");

          return false;
        });

        $('#map-layer-selector .block-chart').click(function(){

          $('#map-layer-selector .block-chart.block-active').removeClass('block-active');
          // add layer
          mapfactory.add_layer(  $('#selectors .active').prop('id') ,$(this).data('dataset') );

          $(this).addClass('block-active');

          return false;
        })
      }

    });
  </script>

{% endblock %}

{% block container %}

  <div class="container">

    <div class="row">

      <div class="span6 block-container" id="map-layer-selector">

        <div class="block-chart block-active" data-dataset="costo">

          <strong class="title">Finanziamento pubblico dei progetti monitorati*</strong>

          <p>{{ total_cost|intword }} <span>di euro</span></p>

          <div class="bar-vertical"></div>

          <div style="position: absolute; bottom: -16px; left: 5px; color: black; font-size: 10px; text-transform: none;">
            *Dati aggiornati al 31.12.2011
          </div>

        </div>

        <div class="block-chart" title="{{ cost_payments_ratio }} del totale" data-dataset="pagamento">

          <strong class="title">Pagamenti effettuati per i progetti monitorati*</strong>

          <p>{{ total_cost_paid|intword }} <span>di euro</span></p>

          <div class="bar-vertical"><span style="height:{{ cost_payments_ratio }}"></span></div>

        </div>

        <div class="block-chart" data-dataset="numero">

          <strong class="title">Numero dei progetti monitorati*</strong>

          <p>{{ total_projects|floatformat:0 }}</p>

        </div>

      </div>
      <div>

        {% block top_content %}

        <a class="block-chart block-gray pull-right" href="/fonti-di-finanziamento/">
          <strong class="title">Totale risorse stanziate*</strong>
          <p>102.668 milioni <span>di euro</span></p>
        </a>

        <p id="claim">“Per promuovere lo sviluppo economico,
          la coesione e la solidarietà sociale, per rimuovere gli squilibri economici e sociali,
          per favorire l'effettivo esercizio dei diritti della persona,
          o per provvedere a scopi diversi dal normale esercizio delle loro funzioni,
          lo Stato destina risorse aggiuntive ed effettua interventi speciali in favore di determinati
          Comuni, Province, Città metropolitane e Regioni.” <br>
          <i>Dall’art. 119 della Costituzione della Repubblica Italiana</i></p>

          {% endblock %}

      </div>

    </div>

  </div>

  <div class="area">
    <div class="container">

      <div class="row" id="statistics">

        <div class="span6">

          <div class="row">

            {% if territorio %}
              <div class="span6">
              <h1 class="title black" style="margin-bottom: 0;"><span>{{ territorio.get_territorio_display }} {% if territorio.territorio != 'R' %}di {% endif %}{{ territorio }}</span></h1>
              <p><a href="{% url progetti_search %}?q=&selected_facets=regions:{{ territorio.cod_reg }}" style="text-transform: none;padding-left: 25px;">Vai a tutti i progetti</a></p>
              </div>
            {% endif %}

            {% if tema %}
              <div class="span6">
                <h1 class="title black" style="margin-bottom: 0;"><span>{{ tema.short_label }}</span></h1>
                <p><a href="{% url progetti_search %}?q=&selected_facets=tema:{{ tema.codice }}" style="text-transform: none;padding-left: 25px;">Vai a tutti i progetti</a></p>
              </div>
            {% endif %}

            {% if tipologia %}
              <div class="span6">
                <h1 class="title black" style="margin-bottom: 0;"><span>{{ tipologia.short_label }}</span></h1>
                <p><a href="{% url progetti_search %}?q=&selected_facets=tipologia:{{ tipologia.codice }}" style="text-transform: none;padding-left: 25px;">Vai a tutti i progetti</a></p>
              </div>
            {% endif %}

            {% if tipologie_principali %}
            <div class="span3{% if tema or tipologia %} offset3{% endif %}">
              <h4>Natura dell'intervento</h4>

              <div id="main_types_chart" style="width: 100%; height: 200px"></div>

              <table id="main_types" class="table">
                {% for tipologia in tipologie_principali %}
                  <tr>
                      {% if territorio %}
                          <td><a href="{% url progetti_search %}?q=&selected_facets=natura:{{ tipologia.object.codice }}&selected_facets=regions:{{ territorio.cod_reg }}" title="{{ tipologia.object.descrizione }}">{{ tipologia.object.short_label }}</a> {%  comment  %}({{ tipologia.data.numero }}) {%  endcomment %}</td>
                      {%  elif tema %}
                          <td><a href="{% url progetti_search %}?q=&selected_facets=natura:{{ tipologia.object.codice }}&selected_facets=tema:{{ tema.codice }}" title="{{ tipologia.object.descrizione }}">{{ tipologia.object.short_label }}</a> {%  comment  %}({{ tipologia.data.numero }}) {%  endcomment %}</td>
                      {%  else %}
                          <td><a href="{{ tipologia.object.get_absolute_url }}" title="{{ tipologia.object.descrizione }}">{{ tipologia.object.short_label }}</a></td>
                      {% endif %}
                    <td class="amount"><strong>{{ tipologia.data.costo|default:"0"|floatformat:0 }}</strong> euro</td>
                  </tr>
                {% endfor %}
              </table>

            </div>
            {% endif %}

            {% if temi_principali %}
            <div class="span3">
              <h4>Temi</h4>

              <div id="main_topics_chart" style="width: 100%; height: 200px"></div>

              <table id="main_topics" class="table">
                {% for tema in temi_principali %}
                  <tr>
                      {% if territorio %}
                          <td><a href="{% url progetti_search %}?q=&selected_facets=tema:{{ tema.object.codice }}&selected_facets=regions:{{ territorio.cod_reg }}" title="{{ tema.object.descrizione }}">{{ tema.object.short_label }}</a> {%  comment %}({{ tema.data.numero }}){%  endcomment %}</td>
                      {%  elif tipologia %}
                          <td><a href="{% url progetti_search %}?q=&selected_facets=tema:{{ tema.object.codice }}&selected_facets=natura:{{ tipologia.codice }}" title="{{ tema.object.descrizione }}">{{ tema.object.short_label }}</a> {%  comment %}({{ tema.data.numero }}){%  endcomment %}</td>
                      {%  else %}
                          <td><a href="{{ tema.object.get_absolute_url }}" title="{{ tema.object.descrizione }}">{{ tema.object.short_label }}</a></td>
                      {% endif %}
                    <td class="amount"><strong>{{ tema.data.costo|default:"0"|floatformat:0 }}</strong> euro</td>

                  </tr>
                {% endfor %}
              </table>

            </div>
            {% endif %}
          </div>

        </div>

        <div class="span6">

          <div id="selectors" class="btn-group">
            {% if territorio.territorio == 'R' %}
              <a href="#" id="province-r-{{ territorio.cod_reg }}" class="btn">province</a><a href="#" id="comuni-r-{{ territorio.cod_reg }}" class="btn active">comuni</a>
            {% elif territorio.territorio == 'P' %}
              <a href="#" id="comuni-p-{{ territorio.cod_prov }}" class="btn active">comuni</a>
            {% elif territorio.territorio == 'C' %}
              <a href="#" id="comuni" class="btn active">{{ territorio }}</a>
            {% else %}
              <a href="#" id="regioni" class="btn active">regioni</a><a href="#" id="province" class="btn">province</a>
            {% endif %}
          </div>
          <div id="map"{% if territorio.territorio == 'C' %} style=" height: 400px; "{% endif %}></div>
          <div id="map-search">
              <form class="form-search content">
                  <div class="input-append">
                      Cerca
                      <input type="text" class="input-medium search-query" placeholder="Inserisci un comune"><button type="submit" class="btn"><i class="icon-search"></i></button>
                  </div>
              </form>
          </div>

            {#          <span id="copy">#}
{#            &copy; 2010#}
{#            <a href="http://www.cloudmade.com/">CloudMade</a>,#}
{#            <a href="http://www.openpolis.it/">Openpolis</a>,#}
{#            <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.#}
{#            Colors by <a href="http://colorbrewer.org/">Cynthia Brewer</a>.#}
{#          </span>#}

        </div>
      </div>

    </div>
  </div>



{% endblock %}