{% extends 'base.html' %}
{% load humanize %}
{% load sekizai_tags %}

{% block page_title %}Progetto: {{ progetto.titolo_progetto }}{% endblock %}

{% block js_content %}
  {% addtoblock "css_link" %}
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}simplegeo-polymaps/examples/example.css">
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}simplegeo-polymaps/lib/colorbrewer/colorbrewer.css">
    <link type="text/css" rel="stylesheet" href="{{ STATIC_URL }}css/map-styles.css">
  {% endaddtoblock %}
  {% addtoblock "js_script" %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/d3.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/protovis/protodata.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/polymaps.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svg.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svgdom.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/highcharts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/charts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/maps.js"></script>
  {% endaddtoblock %}

  {{ block.super }}

  <script type="text/javascript">
    var chart; // globally available

    var pie_chart_options = {
      chart: {
        renderTo: 'container',
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        backgroundColor: 'transparent'
      },
      title: {
        text: ''
      },
      tooltip: {
        formatter: function() {
          return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(2) +' %';
        },
        useHTML: true
      },
      plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
          dataLabels: {
            enabled: false,
            color: '#000000',
            connectorColor: '#000000',
            formatter: function() {
              return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(2) +' %';
            }
          },
          showInLegend: false

        }
      },
      series: [],
      credits: { enabled: false },
      colors: [
          "#ECE7DF", "#CAC7C3", "#979491", "#686462", "#2E2B2A", "#777777", "#AAAAAA", "#BBBBBB", "#CCCCCC", "#DDDDDD", "#EEEEEE"
      ]

    };

    $(document).ready(function() {


      print_pie_chart('#finanziamento_chart_table', 'finanziamento_chart' );

      var tiles_url = "http://{S}tile.cloudmade.com"
          + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
          + "/20760/256/{Z}/{X}/{Y}.png";
      var mapfactory = new MAP( {}, '{{ TILESTACHE_URL }}', tiles_url , d3, org.polymaps, pv);

      mapfactory.build('map', {{ map.extent }}, {{ map.zoomlev|default:"null" }}, {{ map.zoomrange|default:"null" }});

      var poi_list = {{ map.pois|safe }};
      for ( var poi in poi_list ) {
        mapfactory.add_point( poi_list[poi] );
      }
    });
  </script>
{% endblock %}

{% block container %}

  <div class="container">
    <article id="progetto" class="row">
      <div class="span6" id="content">

        <header>
          <h2>CODICE: {{ progetto.codice_locale }}</h2>
          <h1>{{ progetto.titolo_progetto }}</h1>
        </header>

        <ul class="spaced">
          <li>
            <a href="{{ progetto.tema.tema_superiore.get_absolute_url }}">
              {{ progetto.tema.tema_superiore.short_label|upper }}
            </a> -
            {{ progetto.tema.descrizione|upper }}
          </li>
          <li>
            <a href="{{ progetto.classificazione_azione.classificazione_superiore.get_absolute_url }}">
              {{ progetto.classificazione_azione.classificazione_superiore.short_label|upper }}
            </a> -
            {{ progetto.classificazione_azione.descrizione|upper }}
          </li>
        </ul>

        {% if progetto.descrizione %}
          <p>
            {{ progetto.descrizione }}
          </p>
        {% endif %}

        <section>
          <h1 class="title">
            <span>Soggetti</span>
          </h1>

          <div class="row-fluid">
            <div class="span6">
              <dl class="data">
                {% for programmatore in progetto.programmatori %}
                  {% if forloop.first %}
                  <dt>Programmatore</dt>
                  {% endif %}
                <dd><a href="{{ programmatore.get_absolute_url }}">{{ programmatore }}</a></dd>
                {% endfor %}

                {% for destinatario in progetto.destinatarii %}
                  {% if forloop.first %}
                    <dt>Destinatario</dt>
                  {% endif %}
                <dd><a href="{{ destinatario.get_absolute_url }}">{{ destinatario }}</a></dd>
                {% endfor %}
              </dl>
            </div>
            <div class="span6">
              <dl class="data">
                {% for attuatore in progetto.attuatori %}
                  {% if forloop.first %}
                    <dt>Attuatore</dt>
                  {% endif %}
                <dd><a href="{{ attuatore.get_absolute_url }}">{{ attuatore }}</a></dd>
                {% endfor %}

                {% for realizzatore in progetto.realizzatori %}
                  {% if forloop.first %}
                    <dt>Realizzatore</dt>
                  {% endif %}
                <dd><a href="{{ realizzatore.get_absolute_url }}">{{ realizzatore }}</a></dd>
                {% endfor %}
              </dl>

            </div>
          </div>

        </section>

        <section class="row-fluid">
          <div class="span6">
            <h1 class="title">
              <span>Tempi</span>
            </h1>

            <dl class="data">
              <dt>Inizio previsto</dt>
              <dd>{{ progetto.data_inizio_prevista|default:"Dato non disponibile" }}</dd>

              <dt>Inizio effettivo</dt>
              <dd>{{ progetto.data_inizio_effettiva|default:"Dato non disponibile" }}</dd>

              <dt>Fine prevista</dt>
              <dd>{{ progetto.data_fine_prevista|default:"Dato non disponibile" }}</dd>

              <dt>Fine effettiva</dt>
              <dd>{{ progetto.data_fine_effettiva|default:"Dato non disponibile" }}</dd>

              {% if durata_progetto_prevista %}
                <dt>Durata prevista</dt>
                <dd>{{ durata_progetto_prevista }} giorni</dd>
              {% endif %}

              {% if durata_progetto_effettiva %}
                <dt>Durata effettiva</dt>
                <dd>{{ durata_progetto_effettiva }} giorni</dd>
              {% endif %}

{#              {% if giorni_alla_fine %}#}
{#              <dt>Giorni rimanenti</dt>#}
{#              <dd>{{ giorni_alla_fine }} giorni</dd>#}
{#              {% endif %}#}
            </dl>

          </div>
          <div class="span6">
            <h1 class="title" id="map-header">
              <div>
                  Località
                {% for territorio in progetto.territori %}
                  <a href="{{ territorio.get_absolute_url }}">
                    {{ territorio.denominazione }}
                  </a>
                {% endfor %}
              </div>
            </h1>
            <div id="map" style="height:250px; width: 100%;"></div>
          </div>
        </section>

        <h3>Priorità</h3>
        <p>
          {{ progetto.classificazione_qsn.classificazione_superiore.classificazione_superiore.descrizione }}
        </p>

        <h3>Obiettivo generale QSN</h3>
        <p>
          {{ progetto.classificazione_qsn.classificazione_superiore.descrizione }}
        </p>

        <h3>Obiettivo specifico QSN</h3>
        <p>
          {{ progetto.classificazione_qsn.descrizione }}
        </p>

        <p>Aggiornamento: <strong>{{ progetto.data_aggiornamento|date:"m.Y" }}</strong></p>

      </div>



      <aside id="sidebar" class="span6">

        <section>
          <div class="row">
            <h1 class="title span6"><span>Finanziamento pubblico</span></h1>

            <div class="span3 text-center">
              <h2>Finanziamento complessivo*</h2>
              <p><strong>{{ total_cost|intcomma }}</strong> euro</p>
            </div>

            <div class="span3 text-center">
              <h2>Pagamenti effettuati*</h2>
              <p><strong>{{ total_cost_paid|intcomma }}</strong> euro</p>
            </div>
          </div>

          <div class="row" style="height: 150px">
            <div class="span3">
              <div id="finanziamento_chart" style="width: 100%; height: 150px"></div>
            </div>

            <div class="span3">
              <div class="block-chart" title="{{ cost_payments_ratio }} del totale">

                <div class="bar-vertical"><span style="height:{{ cost_payments_ratio }}"></span></div>
                <p>{{ cost_payments_ratio }}</p>

              </div>
            </div>

            <p class="span6 text-center">
              <small>*Dati aggiornati al {{ progetto.data_aggiornamento }} e relativi alla competenza del finanziamento pubblico</small>
            </p>
          </div>

          <table class="table" id="finanziamento_chart_table">
            {% if progetto.fin_ue %}
            <tr><th>Europa</th><td class="amount"><strong>{{ progetto.fin_ue|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_stato_fondo_rotazione %}
            <tr><th>Co-finanziamento nazionale</th><td class="amount"><strong>{{ progetto.fin_stato_fondo_rotazione|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_stato_fsc %}
            <tr><th>Stato FSC</th><td class="amount"><strong>{{ progetto.fin_stato_fsc|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_stato_altri_provvedimenti %}
            <tr><th>Stato altri provvedimenti</th><td class="amount"><strong>{{ progetto.fin_stato_altri_provvedimenti|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_regione %}
            <tr><th>Regione</th><td class="amount"><strong>{{ progetto.fin_regione|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_provincia %}
            <tr><th>Provincia</th><td class="amount"><strong>{{ progetto.fin_provincia|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_comune %}
            <tr><th>Comune</th><td class="amount"><strong>{{ progetto.fin_comune|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
            {% if progetto.fin_altro_pubblico %}
            <tr><th>Altro pubblico</th><td class="amount"><strong>{{ progetto.fin_altro_pubblico|default_if_none:"0"|intcomma }}</strong> euro</td></tr>
            {% endif %}
          </table>

        </section>

        {% if progetto.fondo_comunitario == 'fse' or progetto.fondo_comunitario == 'fesr' %}
        <section>

          <dl class="data">
            <dt>
              {% if progetto.fondo_comunitario == 'fse' %}
                Fondo Strutturale Europeo (FSE)
              {% else %}
                Fondo Europeo di Sviluppo Regionale (FESR)
                {% endif %}
            </dt>
            <dd>{{ progetto.fonte.descrizione }}</dd>
            <dt>Programma</dt>
            <dd>
              <a href="{{ progetto.programma_asse_obiettivo.classificazione_superiore.classificazione_superiore.url_riferimento|default_if_none:"#" }}">
                {{ progetto.programma_asse_obiettivo.classificazione_superiore.classificazione_superiore.descrizione }}
              </a>
            </dd>
            <dt>Asse</dt>
            <dd>{{ progetto.programma_asse_obiettivo.classificazione_superiore.descrizione }}</dd>
            <dt>Obiettivo</dt>
            <dd>{{ progetto.programma_asse_obiettivo.descrizione }}</dd>
          </dl>

        </section>
        {% endif %}

        {% if progetto.fin_stato_estero or progetto.fin_privato or progetto.fin_da_reperire %}

        <hr>

        <section>
          <h1 class="title"><span>Altre risorse</span></h1>

          <table class="table">
            {% if progetto.fin_stato_estero %}
            <tr>
              <th>Stati Esteri</th>
              <td class="amount"><span>{{ progetto.fin_stato_estero|intcomma }}</span> euro</td>
            </tr>
            {% endif %}
            {% if progetto.fin_privato %}
            <tr>
              <th>Privati</th>
              <td class="amount"><span>{{ progetto.fin_privato|intcomma }}</span> euro</td>
            </tr>
            {% endif %}
            {% if progetto.fin_da_reperire %}
            <tr>
              <th>Da reperire</th>
              <td class="amount"><span>{{ progetto.fin_da_reperire|intcomma }}</span> euro</td>
            </tr>
            {% endif %}
          </table>

        </section>

      {% endif %}

      </aside>
    </article>
  </div>


  <div class="area">
    <div class="container">
      <div class="row">

        <h3 class="span12">Altri progetti sul territorio</h3>

        <div class="span6">
          <h1 class="title"><span>Stesso tema</span></h1>
          <table>
            {% for p in stesso_tema  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
        <div class="span6">
          <h1 class="title"><span>Stessi destinatari</span></h1>
          <table>
            {% for p in stessi_destinatari  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="span6">
          <h1 class="title"><span>Stessa tipologia</span></h1>
          <table>
            {% for p in stesso_tipo  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
        <div class="span6">
          <h1 class="title"><span>Stessi realizzatori</span></h1>
          <table>
            {% for p in stessi_realizzatori  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}