{% extends 'base.html' %}
{% load humanize %}
{% load sekizai_tags %}

{% block page_title %}Progetto: {{ progetto.titolo_progetto }}{% endblock %}

{% block js_content %}
  {% addtoblock "js_script" %}
    <script type="text/javascript" src="{{ STATIC_URL }}js/highcharts.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}js/maps.js"></script>
  {% endaddtoblock %}

  {{ block.super }}

  <script type="text/javascript">
    var chart; // globally available

    var pie_chart_options = {
      chart: {
        renderTo: 'container',
        plotBackgroundColor: null,
        plotBorderWidth: null,
        plotShadow: false,
        backgroundColor: 'transparent'
      },
      title: {
        text: ''
      },
      tooltip: {
        formatter: function() {
          return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(2) +' %';
        },
        useHTML: true
      },
      plotOptions: {
        pie: {
          allowPointSelect: true,
          cursor: 'pointer',
          dataLabels: {
            enabled: false,
            color: '#000000',
            connectorColor: '#000000',
            formatter: function() {
              return '<b>'+ this.point.name +'</b>: '+ this.percentage.toFixed(2) +' %';
            }
          },
          showInLegend: false

        }
      },
      series: [],
      credits: { enabled: false }
    };

    $(document).ready(function() {


      // Main topics chart
      var total = 0;
      var main_topics_options = pie_chart_options;
      main_topics_options.chart.renderTo = 'finanziamento_chart';
      var series = {
        type: 'pie',
        data: [
          ['Europa', {{ progetto.fin_ue|default_if_none:"0" }}],
          ['Stato fondo rotazione', {{ progetto.fin_stato_fondo_rotazione|default_if_none:"0" }}],
          ['Stato FSC', {{ progetto.fin_stato_fsc|default_if_none:"0" }}],
          ['Stato altri provvedimenti', {{ progetto.fin_stato_altri_provvedimenti|default_if_none:"0" }}],
          ['Regione', {{ progetto.fin_regione|default_if_none:"0" }}],
          ['Provincia', {{ progetto.fin_provincia|default_if_none:"0" }}],
          ['Comune', {{ progetto.fin_comune|default_if_none:"0" }}],
          ['Altro pubblico', {{ progetto.fin_altro_pubblico|default_if_none:"0" }}]
        ]
      };
      main_topics_options.series.push(series);
      chart = new Highcharts.Chart(main_topics_options);
      // End Main topics chart

    });
  </script>
{% endblock %}

{% block container %}

  <div class="container">
    <article class="row">
      <div class="span6" id="content">

        <div class="flat_content">
          <header>
            <h2>CUP N. {{ progetto.codice_locale }}</h2>
            <h1>{{ progetto.titolo_progetto }}</h1>
          </header>

          <ul class="spaced">
            <li>
              <a href="{{ progetto.tema.get_absolute_url }}">
                {{ progetto.tema.tema_superiore.short_label|upper }}
              </a> -
              {{ progetto.tema.descrizione|upper }}
            </li>
            <li>
              <a href="{{ progetto.classificazione_azione.get_absolute_url }}">
                {{ progetto.classificazione_azione.classificazione_superiore.short_label|upper }}
              </a> -
              {{ progetto.classificazione_azione.descrizione|upper }}
            </li>
          </ul>

          {% if progetto.descrizione %}
            <p>
              {{ progetto.descrizione }}
            </p>
          {% endif %}
        </div>

        <section class="row">
          <h1 class="span6 title">
            <span>Soggetti</span>
          </h1>


          <div class="span3">
            <dl class="data">
              {% for programmatore in progetto.programmatori %}
                {% if forloop.first %}
                <dt>Programmatore</dt>
                {% endif %}
              <dd><a href="{{ programmatore.get_absolute_url }}">{{ programmatore }}</a></dd>
              {% endfor %}

              {% for destinatario in progetto.destinatarii %}
                {% if forloop.first %}
                  <dt>Destinatario</dt>
                {% endif %}
              <dd><a href="{{ destinatario.get_absolute_url }}">{{ destinatario }}</a></dd>
              {% endfor %}
            </dl>
          </div>
          <div class="span3">
            <dl class="data">
              {% for attuatore in progetto.attuatori %}
                {% if forloop.first %}
                  <dt>Attuatore</dt>
                {% endif %}
              <dd><a href="{{ attuatore.get_absolute_url }}">{{ attuatore }}</a></dd>
              {% endfor %}

              {% for realizzatore in progetto.realizzatori %}
                {% if forloop.first %}
                  <dt>Realizzatore</dt>
                {% endif %}
              <dd><a href="{{ realizzatore.get_absolute_url }}">{{ realizzatore }}</a></dd>
              {% endfor %}
            </dl>

          </div>

        </section>

        <section class="row">
          <div class="span3">
            <h1 class="title">
              <span>Tempi</span>
            </h1>

            <dl class="data">
              <dt>Inizio</dt>
              <dd>{{ progetto.data_inizio_effettiva|default:"Dato non disponibile" }}</dd>

              <dt>Fine prevista</dt>
              <dd>{{ progetto.data_fine_prevista|default:"Dato non disponibile" }}</dd>

              <dt>Fine effettiva</dt>
              <dd>{{ progetto.data_fine_effettiva|default:"Dato non disponibile" }}</dd>

              {% if durata_progetto %}
              <dt>Durata</dt>
              <dd>{{ durata_progetto }}</dd>
              {% endif %}

              {% if giorni_alla_fine %}
              <dt>Giorni rimanenti</dt>
              <dd>{{ giorni_alla_fine }}</dd>
              {% endif %}
            </dl>

          </div>
          <div class="span3">
            <h1 class="title">
              <div>Località</div>
            </h1>
          </div>
        </section>

        <h3>Priorità</h3>
        <p>
          {{ progetto.classificazione_qsn.classificazione_superiore.classificazione_superiore.descrizione }}
        </p>

        <h3>Obiettivo generale QSN</h3>
        <p>
          {{ progetto.classificazione_qsn.classificazione_superiore.descrizione }}
        </p>

        <h3>Obiettivo specifico QSN</h3>
        <p>
          {{ progetto.classificazione_qsn.descrizione }}
        </p>

      </div>



      <aside id="sidebar" class="span6">

        <section>
          <div class="row">
            <h1 class="title span6"><span>Finanziamento pubblico</span></h1>

            <div class="span3 text-center">
              <h2>Finanziamento complessivo*</h2>
              <p><strong>{{ total_cost|intcomma }}</strong> euro</p>
            </div>

            <div class="span3 text-center">
              <h2>Pagamenti effettuati*</h2>
              <p><strong>{{ total_cost_paid|intcomma }}</strong> euro</p>
            </div>
          </div>

          <div class="row" style="height: 150px">
            <div class="span3">
              <div id="finanziamento_chart" style="width: 100%; height: 150px"></div>
            </div>

            <div class="span3">
              <div class="block-chart" title="{{ cost_payments_ratio }} del totale">

                <div class="bar-vertical"><span style="height:{{ cost_payments_ratio }}"></span></div>
                <p>{{ cost_payments_ratio }}</p>

              </div>
            </div>

            <p class="span6 text-center">
              <small>*Dati aggiornati al {{ progetto.data_aggiornamento }} e relativi alla competenza del finanziamento pubblico</small>
            </p>


          </div>

        </section>

        {% if progetto.fondo_comunitario == 'fse' or progetto.fondo_comunitario == 'fers' %}
        <section>

          <dl class="data">
            <dt>
              {% if progetto.fondo_comunitario == 'fse' %}
                Fondo Strutturale Europeo (FSE)
              {% else %}
                Fondo Europeo di Sviluppo Regionale (FERS)
                {% endif %}
            </dt>
            <dd>{{ progetto.fonte.descrizione }}</dd>
            <dt>Programma</dt>
            <dd>{{ progetto.programma_asse_obiettivo.classificazione_superiore.classificazione_superiore.descrizione }}</dd>
            <dt>Asse</dt>
            <dd>{{ progetto.programma_asse_obiettivo.classificazione_superiore.descrizione }}</dd>
            <dt>Obiettivo</dt>
            <dd>{{ progetto.programma_asse_obiettivo.descrizione }}</dd>
          </dl>

        </section>
        {% endif %}

        {% if progetto.fin_stato_estero or progetto.fin_privato or progetto.fin_da_reperire %}

        <hr>

        <section>
          <h1 class="title"><span>Altre risorse</span></h1>

          <table class="table">
            {% if progetto.fin_stato_estero %}
            <tr>
              <th>Stati Esteri</th>
              <td class="amount"><span>{{ progetto.fin_stato_estero|intcomma }}</span> euro</td>
            </tr>
            {% endif %}
            {% if progetto.fin_privato %}
            <tr>
              <th>Privati</th>
              <td class="amount"><span>{{ progetto.fin_privato|intcomma }}</span> euro</td>
            </tr>
            {% endif %}
            {% if progetto.fin_da_reperire %}
            <tr>
              <th>Da reperire</th>
              <td class="amount"><span>{{ progetto.fin_da_reperire|intcomma }}</span> euro</td>
            </tr>
            {% endif %}
          </table>

        </section>

      {% endif %}

      </aside>
    </article>
  </div>


  <div class="area">
    <div class="container">
      <div class="row">

        <h3 class="span12">Altri progetti sul territorio</h3>

        <div class="span6">
          <h1 class="title"><span>Stesso tema</span></h1>
          <table>
            {% for p in stesso_tema  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
        <div class="span6">
          <h1 class="title"><span>Stessi destinatari</span></h1>
          <table>
            {% for p in stessi_destinatari  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
      </div>

      <hr>

      <div class="row">
        <div class="span6">
          <h1 class="title"><span>Stessa tipologia</span></h1>
          <table>
            {% for p in stesso_tipo  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
        <div class="span6">
          <h1 class="title"><span>Stessi realizzatori</span></h1>
          <table>
            {% for p in stessi_realizzatori  %}
              <tr>
                <td class="span6"><a href="{{ p.get_absolute_url }}">{{ p.titolo_progetto }}</a></td>
                <td class="amount"><strong>{{ p.fin_totale_pubblico|intcomma }}</strong> euro</td>
              </tr>
            {% endfor %}
          </table>
        </div>
      </div>
    </div>
  </div>
{% endblock %}