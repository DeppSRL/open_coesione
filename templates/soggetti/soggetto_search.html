{% extends 'base_two_columns.html' %}

{% load staticfiles sekizai_tags digg_paginator utils %}

{% block page_title %}Elenco soggetti {% endblock page_title %}
{% block page_description %}Elenco dei soggetti, navigabile a faccette, con possibilità di ricerca testuale.{% endblock page_description %}

{% block content %}
    {% if n_results %}
        <section style="clear: both">
            <h3>Trovati {{ n_results }} soggetti</h3>

            <hr class="big">

            <table class="search-results table">
                <thead>
                    <tr>
                        <th>Ruolo</th>
                        <th>Denominazione</th>
                        <th class="text-right">Finanziamenti (€)</th>
                        <th class="text-right">Progetti</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in page_obj.object_list %}
                        <tr>
                            <td class="span1">
                                {% for r in result.ruolo %}
                                    {{ ruolo.denominazione|key:r }}<br/>
                                {% endfor %}
                            </td>
                            <td class="span5">
                                {{ result.rendered|safe }}
                            </td>
                            <td class="amount span1">
                                <strong>{{ result.costo|default:'0.0'|floatformat:'2' }}</strong>
                            </td>
                            <td class="amount span1">
                                <strong>{{ result.n_progetti|default:'0' }}</strong>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </section>

        {% addtoblock 'css' strip %}
            <link rel="stylesheet" href="{% static 'css/digg_paginator.css' %}" />
        {% endaddtoblock %}

        {% digg_paginator %}
    {% else %}
        <p>Nessun risultato trovato.</p>
    {% endif %}
{% endblock %}

{% block sidebar %}
    <div class="flat_content">
        <h4>Cerca tra i soggetti</h4>

        <form method="get" action="{% url 'soggetti_search' %}" class="form-search form-condensed">
            {% include 'commons/search_form.html' %}
        </form>

        <br/>

        {% if n_results %}
            {% if selected_facets %}
                <h3>Modifica i filtri</h3>
                {% for facet in selected_facets %}
                    {% if facet.field == 'ruolo' and facets.fields.ruolo.is_field_selected %}
                        <dt>Ruoli</dt>
                        <dd>
                            <a href="{{ facet.url }}"><i class="icon-remove" title="rimuovi questo filtro"></i></a>
                            {{ ruolo.denominazione|key:facet.r_label|safe }}
                        </dd>
                    {% endif %}
                    {% if facet.field == 'tema' and facets.fields.tema.is_field_selected %}
                        <dt>Tema</dt>
                        <dd>
                            <a href="{{ facet.url }}"><i class="icon-remove" title="rimuovi questo filtro"></i></a>
                            {{ tema.short_label|key:facet.r_label|safe }}
                        </dd>
                    {% endif %}
                    {% if facet.field == 'costo' and facet_queries_costo.is_selected %}
                        <dt>Finanziamenti</dt>
                        <dd>
                            <a href="{{ facet.url }}"><i class="icon-remove" title="rimuovi questo filtro"></i></a>
                            {{ facet.r_label|safe }}
                        </dd>
                    {% endif %}
                    {% if facet.field == 'n_progetti' and facet_queries_n_progetti.is_selected %}
                        <dt>Numero di progetti</dt>
                        <dd>
                            <a href="{{ facet.url }}"><i class="icon-remove" title="rimuovi questo filtro"></i></a>
                            {{ facet.r_label|safe }}
                        </dd>
                    {% endif %}
                {% endfor %}
            {% else %}
                <h4>Filtra</h4>
                <p>
                    Puoi trovare il soggetto scorrendo la lista, qui al lato. Puoi perfezionare la ricerca usando i filtri qui sotto,
                    oppure puoi usare il form di ricerca con una parola che pensi sia contenuta nella denominazione del soggetto o con il suo codice fiscale, in cima a questa colonna.
                </p>
            {% endif %}

            <div>
                <dl>
                    {% if facets.fields.ruolo and not facets.fields.ruolo.is_field_selected %}
                        <dt>Ruolo</dt>
                        {% for t in facets.fields.ruolo.counts %}
                            {% if t.1 %}
                                <dd>
                                    {% if not t.2 %}
                                        <a href="{{ base_url }}&selected_facets=ruolo:{{ t.0|urlencode }}" title="{{ ruolo.denominazione|key:t.0 }}">{{ ruolo.denominazione|key:t.0 }}</a>
                                        ({{ t.1 }})
                                    {% endif %}
                                </dd>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </dl>
                <dl>
                    {% if facets.fields.tema and not facets.fields.tema.is_field_selected %}
                        <dt>Tema</dt>
                        {% for t in facets.fields.tema.counts %}
                            {% if t.1 %}
                                <dd>
                                    {% if not t.2 %}
                                        <a href="{{ base_url }}&selected_facets=tema:{{ t.0|urlencode }}" title="{{ tema.descrizione|key:t.0 }}">{{ tema.short_label|key:t.0 }}</a>
                                        ({{ t.1 }})
                                    {% endif %}
                                </dd>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </dl>
                <dl>
                    {% if not facet_queries_costo.is_selected %}
                        <dt>Finanziamenti</dt>
                        {% for range in facet_queries_costo.ranges %}
                            <dd>
                                <a href="{{ base_url }}&selected_facets={{ range.key }}">{{ range.label|safe }}</a>
                                ({{ range.count }})
                            </dd>
                        {% endfor %}
                    {% endif %}
                </dl>
                <dl>
                    {% if not facet_queries_n_progetti.is_selected %}
                        <dt>Numero di progetti</dt>
                        {% for range in facet_queries_n_progetti.ranges %}
                            <dd>
                                <a href="{{ base_url }}&selected_facets={{ range.key }}">{{ range.label|safe }}</a>
                                ({{ range.count }})
                            </dd>
                        {% endfor %}
                    {% endif %}
                </dl>
            </div>
        {% endif %}
    </div>
{% endblock %}
