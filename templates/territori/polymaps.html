<!DOCTYPE html>
<html>
<head>
    <title>Polymaps</title>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/protovis/protodata.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/polymaps.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svg.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}simplegeo-polymaps/lib/jquery/jquery.svgdom.js"></script>
    <style type="text/css">

        @import url("{{ STATIC_URL }}simplegeo-polymaps/lib/colorbrewer/colorbrewer.css");
        @import url("{{ STATIC_URL }}simplegeo-polymaps/examples/example.css");

        body {
            border: 0;
        }

        #map {
            background: #E6E6E6;
        }

        .layer path {
            fill: none;
            stroke: #aaa;
            stroke-width: .25px;
            vector-effect: non-scaling-stroke;
        }

        .highlight {
            fill: red;
        }

        .container {
            display: block;
            width: 400px;
            height: 400px;
            margin: auto;
        }

        #regioni path {
            stroke: #fff;
            stroke-width: 1.5px;
            vector-effect: scaling-stroke;
        }

        #copy {
            position: relative;
            color: #000;
            opacity: .5;
        }

        #copy a {
            color: #000;
        }

    </style>
</head>
<body>

<div class="container">
    <hr class="space"/>
    <div id="map"></div>
    <hr class="space"/>


    <span id="copy">
      &copy; 2010
      <a href="http://www.cloudmade.com/">CloudMade</a>,
      <a href="http://www.openpolis.it/">Openpolis</a>,
      <a href="http://creativecommons.org/licenses/by-sa/2.0/">CCBYSA</a>.
      Colors by <a href="http://colorbrewer.org/">Cynthia Brewer</a>.
    </span>
</div>

<script type="text/javascript">
    var n_projects = {
        "5":  130,
        "6":  729,
        "7":  213,
        "8":  141,
        "9":  585,
        "10": 112,
        "11": 266,
        "12": 111,
        "13": 69,
        "14": 16,
        "15": 535,
        "16": 648,
        "17": 82,
        "18": 385,
        "19": 610,
        "20": 80,
        "1":  395,
        "2":  48,
        "3":  3539,
        "4":  110
    };

    ext = [{lon: 6.8013571012438598, lat: 45.466944703267707}, {lon: 7.9395416755310491, lat: 45.987564971072757}]
    var po = org.polymaps;

    // Compute noniles.
    var quantile = pv.Scale.quantile()
            .quantiles(9)
            .domain(pv.values(n_projects))
            .range(0, 8);

    var map = po.map()
            .container(document.getElementById("map").appendChild(po.svg("svg")))
            .extent(ext).zoomBy(-0.3)
            .zoomRange([5, 13])
            .add(po.interact());

    /*
    map.add(po.image()
            .url(po.url("http://{S}tile.cloudmade.com"
            + "/1a1b06b230af4efdbb989ea99e9841af" // http://cloudmade.com/register
            + "/20760/256/{Z}/{X}/{Y}.png")
            .hosts(["a.", "b.", "c.", ""])));
    */

    map.add(po.image()
            .url(po.url("{{ TILESTACHE_URL }}/osm-proxy/{Z}/{X}/{Y}.png")
            .hosts(["a.", "b.", "c.", ""]))
            )


    map.add(po.geoJson()
            .url("{{ TILESTACHE_URL }}/oc-provinces/{Z}/{X}/{Y}.geojson")
            .on("load", load)
            .id("regioni"));

    map.add(po.compass()
            .pan("none"));


    function load(e) {
        for (var i = 0; i < e.features.length; i++) {
            var feature = e.features[i];
            var d = n_projects[feature.data.properties.cod_reg];
            var id = feature.data.properties.id;
            feature.element.setAttribute("class", "q" + quantile(d) + "-" + 9);
            feature.element.appendChild(po.svg("title").appendChild(
                    document.createTextNode(feature.data.properties.denominazione + ": " + d + " progetti"))
                    .parentNode);

            feature.element.setAttribute("ref", feature.data.properties.id);

            /*
            // disable click on drag
            feature.element.addEventListener("click", function(ev){
               alert("http://localhost:8020/" + this.getAttribute("ref"))
            });
            */

        }
    }



    map.container().setAttribute("class", "Greys");
</script>

</body>
</html>
